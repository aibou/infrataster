<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Infrataster : Infrastructure Acceptance Testing Framework">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Infrataster</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/ryotarai/infrataster">View on GitHub</a>

          <h1 id="project_title">Infrataster</h1>
          <h2 id="project_tagline">Infrastructure Acceptance Testing Framework</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/ryotarai/infrataster/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/ryotarai/infrataster/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a id="infrataster" class="anchor" href="#infrataster" aria-hidden="true"><span class="octicon octicon-link"></span></a>Infrataster</h1>

<p><a href="https://gitter.im/ryotarai/infrataster?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://badges.gitter.im/Join%20Chat.svg" alt="Gitter"></a></p>

<p><a href="http://badge.fury.io/rb/infrataster"><img src="https://badge.fury.io/rb/infrataster.png" alt="Gem Version"></a>
<a href="https://codeclimate.com/github/ryotarai/infrataster"><img src="https://codeclimate.com/github/ryotarai/infrataster.png" alt="Code Climate"></a></p>

<p>Infrastructure Behavior Testing Framework.</p>

<h2>
<a id="basic-usage-with-vagrant" class="anchor" href="#basic-usage-with-vagrant" aria-hidden="true"><span class="octicon octicon-link"></span></a>Basic Usage with Vagrant</h2>

<p>First, create <code>Gemfile</code>:</p>

<div class="highlight highlight-ruby"><pre>source <span class="pl-s1"><span class="pl-pds">'</span>https://rubygems.org<span class="pl-pds">'</span></span>

<span class="pl-k">gem</span> <span class="pl-s1"><span class="pl-pds">'</span>infrataster<span class="pl-pds">'</span></span></pre></div>

<p>Install gems:</p>

<pre><code>$ bundle install
</code></pre>

<p>Install Vagrant: <a href="http://docs.vagrantup.com/v2/installation/index.html">Official Docs</a></p>

<p>Create Vagrantfile:</p>

<div class="highlight highlight-ruby"><pre><span class="pl-c"># Vagrantfile</span>
<span class="pl-s3">Vagrant</span>.configure(<span class="pl-s1"><span class="pl-pds">"</span>2<span class="pl-pds">"</span></span>) <span class="pl-k">do </span>|<span class="pl-vo">config</span>|
  config.vm.box <span class="pl-k">=</span> <span class="pl-s1"><span class="pl-pds">"</span>hashicorp/precise64<span class="pl-pds">"</span></span>

  config.vm.define <span class="pl-c1">:proxy</span> <span class="pl-k">do </span>|<span class="pl-vo">c</span>|
    c.vm.network <span class="pl-s1"><span class="pl-pds">"</span>private_network<span class="pl-pds">"</span></span>, <span class="pl-c1">ip:</span> <span class="pl-s1"><span class="pl-pds">"</span>192.168.33.10<span class="pl-pds">"</span></span>
    c.vm.network <span class="pl-s1"><span class="pl-pds">"</span>private_network<span class="pl-pds">"</span></span>, <span class="pl-c1">ip:</span> <span class="pl-s1"><span class="pl-pds">"</span>171.16.33.10<span class="pl-pds">"</span></span>, <span class="pl-c1">virtualbox__intnet:</span> <span class="pl-s1"><span class="pl-pds">"</span>infrataster-example<span class="pl-pds">"</span></span>
  <span class="pl-k">end</span>

  config.vm.define <span class="pl-c1">:app</span> <span class="pl-k">do </span>|<span class="pl-vo">c</span>|
    c.vm.network <span class="pl-s1"><span class="pl-pds">"</span>private_network<span class="pl-pds">"</span></span>, <span class="pl-c1">ip:</span> <span class="pl-s1"><span class="pl-pds">"</span>171.16.33.11<span class="pl-pds">"</span></span>, <span class="pl-c1">virtualbox__intnet:</span> <span class="pl-s1"><span class="pl-pds">"</span>infrataster-example<span class="pl-pds">"</span></span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p>Start VMs:</p>

<pre><code>$ vagrant up
</code></pre>

<p>Initialize rspec directory:</p>

<pre><code>$ rspec --init
  create   spec/spec_helper.rb
  create   .rspec
</code></pre>

<p><code>require 'infrataster/rspec'</code> and define target servers for testing in <code>spec/spec_helper.rb</code>:</p>

<div class="highlight highlight-ruby"><pre><span class="pl-c"># spec/spec_helper.rb</span>
<span class="pl-k">require</span> <span class="pl-s1"><span class="pl-pds">'</span>infrataster/rspec<span class="pl-pds">'</span></span>

<span class="pl-s3">Infrataster</span>::<span class="pl-s3">Server</span>.define(
  <span class="pl-c1">:proxy</span>,           <span class="pl-c"># name</span>
  <span class="pl-s1"><span class="pl-pds">'</span>192.168.0.0/16<span class="pl-pds">'</span></span>, <span class="pl-c"># ip address</span>
  <span class="pl-c1">vagrant:</span> <span class="pl-c1">true</span>     <span class="pl-c"># for vagrant VM</span>
)
<span class="pl-s3">Infrataster</span>::<span class="pl-s3">Server</span>.define(
  <span class="pl-c1">:app</span>,             <span class="pl-c"># name</span>
  <span class="pl-s1"><span class="pl-pds">'</span>172.16.0.0/16<span class="pl-pds">'</span></span>,  <span class="pl-c"># ip address</span>
  <span class="pl-c1">vagrant:</span> <span class="pl-c1">true</span>,    <span class="pl-c"># for vagrant VM</span>
  <span class="pl-c1">from:</span> <span class="pl-c1">:proxy</span>      <span class="pl-c"># access to this machine via SSH port forwarding from proxy</span>
)

<span class="pl-c"># Code generated by `rspec --init` is following...</span></pre></div>

<p>Or</p>

<div class="highlight highlight-ruby"><pre><span class="pl-c"># spec/spec_helper.rb</span>
<span class="pl-k">require</span> <span class="pl-s1"><span class="pl-pds">'</span>infrataster/rspec<span class="pl-pds">'</span></span>

<span class="pl-s3">Infrataster</span>::<span class="pl-s3">Server</span>.define(<span class="pl-c1">:proxy</span>) <span class="pl-k">do </span>|<span class="pl-vo">server</span>|
    server.address <span class="pl-k">=</span> <span class="pl-s1"><span class="pl-pds">'</span>192.168.0.0/16<span class="pl-pds">'</span></span>
    server.vagrant <span class="pl-k">=</span> <span class="pl-c1">true</span>
<span class="pl-k">end</span>
<span class="pl-s3">Infrataster</span>::<span class="pl-s3">Server</span>.define(<span class="pl-c1">:app</span>) <span class="pl-k">do </span>|<span class="pl-vo">server</span>|
    server.address <span class="pl-k">=</span> <span class="pl-s1"><span class="pl-pds">'</span>172.16.0.0/16<span class="pl-pds">'</span></span>
    server.vagrant <span class="pl-k">=</span> <span class="pl-c1">true</span>
    server.from <span class="pl-k">=</span> <span class="pl-c1">:proxy</span>
<span class="pl-k">end</span>

<span class="pl-c"># Code generated by `rspec --init` is following...</span></pre></div>

<p>Then, you can write spec files:</p>

<div class="highlight highlight-ruby"><pre><span class="pl-c"># spec/example_spec.rb</span>
<span class="pl-k">require</span> <span class="pl-s1"><span class="pl-pds">'</span>spec_helper<span class="pl-pds">'</span></span>

describe server(<span class="pl-c1">:app</span>) <span class="pl-k">do</span>
  describe http(<span class="pl-s1"><span class="pl-pds">'</span>http://app<span class="pl-pds">'</span></span>) <span class="pl-k">do</span>
    it <span class="pl-s1"><span class="pl-pds">"</span>responds content including 'Hello Sinatra'<span class="pl-pds">"</span></span> <span class="pl-k">do</span>
      expect(response.body).to <span class="pl-k">include</span>(<span class="pl-s1"><span class="pl-pds">'</span>Hello Sinatra<span class="pl-pds">'</span></span>)
    <span class="pl-k">end</span>
    it <span class="pl-s1"><span class="pl-pds">"</span>responds as 'text/html'<span class="pl-pds">"</span></span> <span class="pl-k">do</span>
      expect(response.headers[<span class="pl-s1"><span class="pl-pds">'</span>content-type<span class="pl-pds">'</span></span>]).to eq(<span class="pl-s1"><span class="pl-pds">"</span>text/html<span class="pl-pds">"</span></span>)
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p>Run tests:</p>

<pre><code>$ bundle exec rspec
2 examples, 2 failures
</code></pre>

<p>Currently, the tests failed because the VM doesn't respond to HTTP request.</p>

<p>It's time to write provisioning instruction like Chef's cookbooks or Puppet's manifests!</p>

<h2>
<a id="server" class="anchor" href="#server" aria-hidden="true"><span class="octicon octicon-link"></span></a>Server</h2>

<p>"Server" is a server you tests. This supports Vagrant, which is very useful to run servers for testing. Of course, you can test real servers.</p>

<p>You should define servers in <code>spec_helper.rb</code> like the following:</p>

<div class="highlight highlight-ruby"><pre><span class="pl-s3">Infrataster</span>::<span class="pl-s3">Server</span>.define(
  <span class="pl-c"># Name of the server, this will be used in the spec files.</span>
  <span class="pl-c1">:proxy</span>,
  <span class="pl-c"># IP address of the server</span>
  <span class="pl-s1"><span class="pl-pds">'</span>192.168.0.0/16<span class="pl-pds">'</span></span>,
  <span class="pl-c"># If the server is provided by vagrant and this option is true,</span>
  <span class="pl-c"># SSH configuration to connect to this server is got from `vagrant ssh-config` command automatically.</span>
  <span class="pl-c1">vagrant:</span> <span class="pl-c1">true</span>,
)

<span class="pl-s3">Infrataster</span>::<span class="pl-s3">Server</span>.define(
  <span class="pl-c"># Name of the server, this will be used in the spec files.</span>
  <span class="pl-c1">:app</span>,
  <span class="pl-c"># IP address of the server</span>
  <span class="pl-s1"><span class="pl-pds">'</span>172.16.0.0/16<span class="pl-pds">'</span></span>,
  <span class="pl-c"># If the server is provided by vagrant and this option is true,</span>
  <span class="pl-c"># SSH configuration to connect to this server is got from `vagrant ssh-config` command automatically.</span>
  <span class="pl-c1">vagrant:</span> <span class="pl-c1">true</span>,
  <span class="pl-c"># Which gateway is used to connect to this server by SSH port forwarding?</span>
  <span class="pl-c1">from:</span> <span class="pl-c1">:proxy</span>,
  <span class="pl-c"># options for resources</span>
  <span class="pl-c1">mysql:</span> {<span class="pl-c1">user:</span> <span class="pl-s1"><span class="pl-pds">'</span>app<span class="pl-pds">'</span></span>, <span class="pl-c1">password:</span> <span class="pl-s1"><span class="pl-pds">'</span>app<span class="pl-pds">'</span></span>},
)</pre></div>

<p>You can specify SSH configuration manually too:</p>

<div class="highlight highlight-ruby"><pre><span class="pl-s3">Infrataster</span>::<span class="pl-s3">Server</span>.define(
  <span class="pl-c"># ...</span>
  <span class="pl-c1">ssh:</span> {<span class="pl-c1">host_name:</span> <span class="pl-s1"><span class="pl-pds">'</span>hostname<span class="pl-pds">'</span></span>, <span class="pl-c1">user:</span> <span class="pl-s1"><span class="pl-pds">'</span>testuser<span class="pl-pds">'</span></span>, <span class="pl-c1">keys:</span> [<span class="pl-s1"><span class="pl-pds">'</span>/path/to/id_rsa<span class="pl-pds">'</span></span>]}
)</pre></div>

<h3>
<a id="fuzzy-ip-address" class="anchor" href="#fuzzy-ip-address" aria-hidden="true"><span class="octicon octicon-link"></span></a>fuzzy IP address</h3>

<p>Infrataster has "fuzzy IP address" feature. You can pass IP address which has netmask (= CIDR) to <code>Infrataster::Server#define</code>. This needs <code>vagrant</code> option or <code>ssh</code> option which has <code>host_name</code> because this fetches all IP address via SSH and find the matching one.</p>

<div class="highlight highlight-ruby"><pre><span class="pl-s3">Infrataster</span>::<span class="pl-s3">Server</span>.define(
  <span class="pl-c1">:app</span>,
  <span class="pl-c"># find IP address matching 172.16.0.0 ~ 172.16.255.255</span>
  <span class="pl-s1"><span class="pl-pds">'</span>172.16.0.0/16<span class="pl-pds">'</span></span>,</pre></div>

<p>Of course, you can set fully-specified IP address too.</p>

<div class="highlight highlight-ruby"><pre><span class="pl-s3">Infrataster</span>::<span class="pl-s3">Server</span>.define(
  <span class="pl-c1">:app</span>,
  <span class="pl-s1"><span class="pl-pds">'</span>172.16.11.22<span class="pl-pds">'</span></span>,
  <span class="pl-c"># or</span>
  <span class="pl-s1"><span class="pl-pds">'</span>172.16.11.22/32<span class="pl-pds">'</span></span>,</pre></div>

<h3>
<a id="ssh_exec" class="anchor" href="#ssh_exec" aria-hidden="true"><span class="octicon octicon-link"></span></a>#ssh_exec</h3>

<p>You can execute a command on the server like the following:</p>

<div class="highlight highlight-ruby"><pre>describe server(<span class="pl-c1">:proxy</span>) <span class="pl-k">do</span>
  let(<span class="pl-c1">:time</span>) { <span class="pl-s3">Time</span>.now }
  before <span class="pl-k">do</span>
    current_server.ssh_exec <span class="pl-s1"><span class="pl-pds">"</span>echo 'Hello' &gt; /tmp/test-<span class="pl-pse">#{</span><span class="pl-s2">time.to_i</span><span class="pl-pse"><span class="pl-s2">}</span></span><span class="pl-pds">"</span></span>
  <span class="pl-k">end</span>
  it <span class="pl-s1"><span class="pl-pds">"</span>executes a command on the current server<span class="pl-pds">"</span></span> <span class="pl-k">do</span>
    result <span class="pl-k">=</span> current_server.ssh_exec(<span class="pl-s1"><span class="pl-pds">"</span>cat /tmp/test-<span class="pl-pse">#{</span><span class="pl-s2">time.to_i</span><span class="pl-pse"><span class="pl-s2">}</span></span><span class="pl-pds">"</span></span>)
    expect(result.chomp).to eq(<span class="pl-s1"><span class="pl-pds">'</span>Hello<span class="pl-pds">'</span></span>)
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p>This is useful to test cases which depends on the status of the server.</p>

<h2>
<a id="resources" class="anchor" href="#resources" aria-hidden="true"><span class="octicon octicon-link"></span></a>Resources</h2>

<p>"Resource" is what you test by Infrataster. For instance, the following code describes <code>http</code> resource.</p>

<div class="highlight highlight-ruby"><pre>describe server(<span class="pl-c1">:app</span>) <span class="pl-k">do</span>
  describe http(<span class="pl-s1"><span class="pl-pds">'</span>http://example.com<span class="pl-pds">'</span></span>) <span class="pl-k">do</span>
    it <span class="pl-s1"><span class="pl-pds">"</span>responds content including 'Hello Sinatra'<span class="pl-pds">"</span></span> <span class="pl-k">do</span>
      expect(response.body).to <span class="pl-k">include</span>(<span class="pl-s1"><span class="pl-pds">'</span>Hello Sinatra<span class="pl-pds">'</span></span>)
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<h3>
<a id="http-resource" class="anchor" href="#http-resource" aria-hidden="true"><span class="octicon octicon-link"></span></a>
<code>http</code> resource</h3>

<p><code>http</code> resource tests HTTP response when sending HTTP request.
It accepts <code>method</code>, <code>params</code> and <code>header</code> as options.</p>

<div class="highlight highlight-ruby"><pre>describe server(<span class="pl-c1">:app</span>) <span class="pl-k">do</span>
  describe http(
    <span class="pl-s1"><span class="pl-pds">'</span>http://app.example.com<span class="pl-pds">'</span></span>,
    <span class="pl-c1">method:</span> <span class="pl-c1">:post</span>,
    <span class="pl-c1">params:</span> {<span class="pl-s1"><span class="pl-pds">'</span>foo<span class="pl-pds">'</span></span> =&gt; <span class="pl-s1"><span class="pl-pds">'</span>bar<span class="pl-pds">'</span></span>},
    <span class="pl-c1">headers:</span> {<span class="pl-s1"><span class="pl-pds">'</span>USER<span class="pl-pds">'</span></span> =&gt; <span class="pl-s1"><span class="pl-pds">'</span>VALUE<span class="pl-pds">'</span></span>}
  ) <span class="pl-k">do</span>
    it <span class="pl-s1"><span class="pl-pds">"</span>responds with content including 'app'<span class="pl-pds">"</span></span> <span class="pl-k">do</span>
      expect(response.body).to <span class="pl-k">include</span>(<span class="pl-s1"><span class="pl-pds">'</span>app<span class="pl-pds">'</span></span>)

      <span class="pl-c"># `response` is a instance of `Faraday::Response`</span>
      <span class="pl-c"># See: https://github.com/lostisland/faraday/blob/master/lib/faraday/response.rb</span>
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<h3>
<a id="capybara-resource" class="anchor" href="#capybara-resource" aria-hidden="true"><span class="octicon octicon-link"></span></a>
<code>capybara</code> resource</h3>

<p><code>capybara</code> resource tests your web application by simulating real user's interaction.</p>

<div class="highlight highlight-ruby"><pre>describe server(<span class="pl-c1">:app</span>) <span class="pl-k">do</span>
  describe capybara(<span class="pl-s1"><span class="pl-pds">'</span>http://app.example.com<span class="pl-pds">'</span></span>) <span class="pl-k">do</span>
    it <span class="pl-s1"><span class="pl-pds">'</span>shows food list<span class="pl-pds">'</span></span> <span class="pl-k">do</span>
      visit <span class="pl-s1"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>
      click_link <span class="pl-s1"><span class="pl-pds">'</span>Foods<span class="pl-pds">'</span></span>
      expect(page).to have_content <span class="pl-s1"><span class="pl-pds">'</span>Yummy Soup<span class="pl-pds">'</span></span>
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<h3>
<a id="mysql_query-resource" class="anchor" href="#mysql_query-resource" aria-hidden="true"><span class="octicon octicon-link"></span></a>
<code>mysql_query</code> resource</h3>

<p><code>mysql_query</code> resource is now in <a href="https://github.com/ryotarai/infrataster-plugin-mysql">infrataster-plugin-mysql</a>.</p>

<h3>
<a id="pgsql_query-resource" class="anchor" href="#pgsql_query-resource" aria-hidden="true"><span class="octicon octicon-link"></span></a>
<code>pgsql_query</code> resource</h3>

<p><code>pgsql_query</code> resource sends a query to PostgreSQL server.</p>

<p><code>pgsql_query</code> is provided by <a href="https://github.com/SnehaM/infrataster-plugin-pgsql">infrataster-plugin-pgsql</a> by <a href="https://github.com/SnehaM">@SnehaM</a>.</p>

<h3>
<a id="dns-resource" class="anchor" href="#dns-resource" aria-hidden="true"><span class="octicon octicon-link"></span></a>
<code>dns</code> resource</h3>

<p><code>dns</code> resource send query to DNS server.</p>

<p><code>dns</code> is provided by <a href="https://github.com/otahi/infrataster-plugin-dns">infrataster-plugin-dns</a> by <a href="https://github.com/otahi">@otahi</a>.</p>

<h2>
<a id="example" class="anchor" href="#example" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example</h2>

<ul>
<li><a href="example">example</a></li>
<li><a href="spec/integration">spec/integration</a></li>
</ul>

<h2>
<a id="tests" class="anchor" href="#tests" aria-hidden="true"><span class="octicon octicon-link"></span></a>Tests</h2>

<h3>
<a id="unit-tests" class="anchor" href="#unit-tests" aria-hidden="true"><span class="octicon octicon-link"></span></a>Unit Tests</h3>

<p>Unit tests are under <code>spec/unit</code> directory.</p>

<pre><code>$ bundle exec rake spec:unit
</code></pre>

<h3>
<a id="integration-tests" class="anchor" href="#integration-tests" aria-hidden="true"><span class="octicon octicon-link"></span></a>Integration Tests</h3>

<p>Integration tests are under <code>spec/integration</code> directory.</p>

<pre><code>$ bundle exec rake spec:integration:prepare
$ bundle exec rake spec:integration
</code></pre>

<h2>
<a id="presentations" class="anchor" href="#presentations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Presentations</h2>

<ul>
<li><a href="https://speakerdeck.com/ryotarai/introducing-infrataster">https://speakerdeck.com/ryotarai/introducing-infrataster</a></li>
</ul>

<p><a href="https://speakerdeck.com/ryotarai/introducing-infrataster">
<img src="http://i.gyazo.com/305b8b041acd3569268ece4e07e2517a.png" alt="Introducing Infrataster" width="300px">
</a></p>

<ul>
<li><a href="https://speakerdeck.com/ryotarai/infrataster-infra-behavior-testing-framework-number-oedo04">https://speakerdeck.com/ryotarai/infrataster-infra-behavior-testing-framework-number-oedo04</a></li>
</ul>

<h2>
<a id="changelog" class="anchor" href="#changelog" aria-hidden="true"><span class="octicon octicon-link"></span></a>Changelog</h2>

<p><a href="CHANGELOG.md">Changelog</a></p>

<h2>
<a id="contributing" class="anchor" href="#contributing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Contributing</h2>

<ol>
<li>Fork it ( <a href="http://github.com/ryotarai/infrataster/fork">http://github.com/ryotarai/infrataster/fork</a> )</li>
<li>Create your feature branch (<code>git checkout -b my-new-feature</code>)</li>
<li>Commit your changes (<code>git commit -am 'Add some feature'</code>)</li>
<li>Push to the branch (<code>git push origin my-new-feature</code>)</li>
<li>Create new Pull Request</li>
</ol>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Infrataster maintained by <a href="https://github.com/ryotarai">ryotarai</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-51089399-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>


  </body>
</html>
